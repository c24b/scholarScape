<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>scholarScape.py</title>
  <link rel="stylesheet" href="pycco.css">
</head>
<body>
<div id="background"></div>
<div id='container'>
  
  <div class='section'>
    <div class='docs'><h1>scholarScape.py</h1></div>
  </div>
  <div class='clearall'>
  <div class='section' id='section-0'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-0'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">networkx</span> <span class="kn">as</span> <span class="nn">nx</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pystache</span>
<span class="kn">import</span> <span class="nn">pprint</span>
<span class="kn">import</span> <span class="nn">shlex</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">urllib</span>
<span class="kn">import</span> <span class="nn">urllib2</span>
<span class="kn">import</span> <span class="nn">zipfile</span>
<span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="n">getrandbits</span>
<span class="kn">from</span> <span class="nn">urllib</span> <span class="kn">import</span> <span class="n">quote_plus</span> <span class="k">as</span> <span class="n">qp</span>

<span class="kn">from</span> <span class="nn">twisted.application</span> <span class="kn">import</span> <span class="n">service</span><span class="p">,</span> <span class="n">internet</span>
<span class="kn">from</span> <span class="nn">twisted.python</span> <span class="kn">import</span> <span class="n">log</span>
<span class="kn">from</span> <span class="nn">twisted.web</span> <span class="kn">import</span> <span class="n">server</span><span class="p">,</span> <span class="n">resource</span><span class="p">,</span> <span class="n">static</span>
<span class="kn">from</span> <span class="nn">twisted.web.static</span> <span class="kn">import</span> <span class="n">File</span>
<span class="kn">from</span> <span class="nn">txjsonrpc.web</span> <span class="kn">import</span> <span class="n">jsonrpc</span>
<span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">nested</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">date</span>
<span class="kn">from</span> <span class="nn">pymongo</span> <span class="kn">import</span> <span class="n">Connection</span><span class="p">,</span> <span class="n">objectid</span>
<span class="kn">from</span> <span class="nn">pymongo.errors</span> <span class="kn">import</span> <span class="n">AutoReconnect</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div><div class='section' id='section-1'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-1'>#</a>
      </div>
      <p>Read config file and fill in mongo and scrapyd config files with custom values
try to connect to DB, send egg to scrapyd server
then start twisted server</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">print</span> <span class="s">&quot;Loading config file...&quot;</span>
<span class="k">try</span> <span class="p">:</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">&quot;config.json&quot;</span><span class="p">,</span><span class="s">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">config_file</span><span class="p">:</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">config_file</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">IOError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="k">print</span> <span class="s">&quot;Could not open config file&quot;</span>
    <span class="k">print</span> <span class="n">e</span>
    <span class="nb">exit</span><span class="p">()</span>    
<span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="k">print</span> <span class="s">&quot;Config file is not valid JSON&quot;</span><span class="p">,</span> <span class="n">e</span>
    <span class="nb">exit</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div><div class='section' id='section-2'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-2'>#</a>
      </div>
      <p>Check if the DB is available</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">try</span> <span class="p">:</span>
    <span class="n">Connection</span><span class="p">(</span><span class="s">&quot;mongodb://&quot;</span> <span class="o">+</span> <span class="n">config</span><span class="p">[</span><span class="s">&#39;mongo&#39;</span><span class="p">][</span><span class="s">&#39;user&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s">&quot;:&quot;</span> <span class="o">+</span> 
            <span class="n">config</span><span class="p">[</span><span class="s">&#39;mongo&#39;</span><span class="p">][</span><span class="s">&#39;passwd&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s">&quot;@&quot;</span> <span class="o">+</span> <span class="n">config</span><span class="p">[</span><span class="s">&#39;mongo&#39;</span><span class="p">][</span><span class="s">&#39;host&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s">&quot;:&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;mongo&#39;</span><span class="p">][</span><span class="s">&#39;port&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span> <span class="o">+</span> <span class="n">config</span><span class="p">[</span><span class="s">&#39;mongo&#39;</span><span class="p">][</span><span class="s">&#39;database&#39;</span><span class="p">]</span> <span class="p">)</span>
<span class="k">except</span> <span class="n">AutoReconnect</span><span class="p">:</span>
    <span class="k">print</span> <span class="s">&quot;Could not connect to mongodb server&quot;</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="s">&#39;mongo&#39;</span><span class="p">]</span>
    <span class="nb">exit</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div><div class='section' id='section-3'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-3'>#</a>
      </div>
      <p>Render the pipeline template </p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">print</span> <span class="s">&quot;Rendering pipelines.py with values from config.json...&quot;</span>
<span class="k">try</span> <span class="p">:</span>
    <span class="k">with</span> <span class="n">nested</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s">&quot;scholar/scholar/pipelines-template.py&quot;</span><span class="p">,</span> <span class="s">&quot;r&quot;</span><span class="p">),</span> <span class="nb">open</span><span class="p">(</span><span class="s">&quot;scholar/scholar/pipelines.py&quot;</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">))</span> <span class="k">as</span> <span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="n">generated</span><span class="p">):</span>
        <span class="n">generated</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pystache</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">template</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">config</span><span class="p">[</span><span class="s">&#39;mongo&#39;</span><span class="p">]))</span>
<span class="k">except</span> <span class="ne">IOError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="k">print</span> <span class="s">&quot;Could not open either pipeline-template file or pipeline file&quot;</span>
    <span class="k">print</span> <span class="s">&quot;scholar/scholar/pipelines-template.py&quot;</span><span class="p">,</span> <span class="s">&quot;scholar/scholar/pipelines.py&quot;</span>
    <span class="k">print</span> <span class="n">e</span>
    <span class="nb">exit</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div><div class='section' id='section-4'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-4'>#</a>
      </div>
      <p>Render the scrapy cfg<br />
</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">print</span> <span class="s">&quot;Rendering scrapy.cfg with values from config.json...&quot;</span>
<span class="k">try</span> <span class="p">:</span>
    <span class="k">with</span> <span class="n">nested</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s">&quot;scholar/scrapy-template.cfg&quot;</span><span class="p">,</span> <span class="s">&quot;r&quot;</span><span class="p">),</span> <span class="nb">open</span><span class="p">(</span><span class="s">&quot;scholar/scrapy.cfg&quot;</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">))</span> <span class="k">as</span> <span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="n">generated</span><span class="p">):</span>
        <span class="n">generated</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pystache</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">template</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">config</span><span class="p">[</span><span class="s">&#39;scrapyd&#39;</span><span class="p">]))</span>
<span class="k">except</span> <span class="ne">IOError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="k">print</span> <span class="s">&quot;Could not open either scrapy.cfg template file or scrapy.cfg&quot;</span>
    <span class="k">print</span> <span class="s">&quot;scholar/scrapy-template.cfg&quot;</span><span class="p">,</span> <span class="s">&quot;scholar/scrapy.cfg&quot;</span>
    <span class="k">print</span> <span class="n">e</span>
    <span class="nb">exit</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div><div class='section' id='section-5'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-5'>#</a>
      </div>
      <p>Deploy the egg   <br />
</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">print</span> <span class="s">&quot;Sending scholarScrape&#39;s scrapy egg to scrapyd server...&quot;</span>
<span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s">&quot;scholar&quot;</span><span class="p">)</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="s">&#39;scrapy&#39;</span><span class="p">,</span><span class="s">&#39;deploy&#39;</span><span class="p">],</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
<span class="n">output</span><span class="p">,</span> <span class="n">errors</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
<span class="k">print</span> <span class="n">output</span><span class="p">,</span> <span class="n">errors</span>
<span class="k">try</span> <span class="p">:</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">output</span><span class="p">[</span><span class="s">&#39;status&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&quot;ok&quot;</span> <span class="p">:</span>
        <span class="k">print</span> <span class="s">&quot;There was a problem sending the scrapy egg.&quot;</span>
        <span class="k">print</span> <span class="n">output</span><span class="p">,</span> <span class="n">errors</span>    
        <span class="nb">exit</span><span class="p">()</span>
<span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
    <span class="k">print</span> <span class="s">&quot;There was a problem sending the scrapy egg.&quot;</span>
    <span class="k">print</span> <span class="n">output</span><span class="p">,</span> <span class="n">errors</span>     
    <span class="nb">exit</span><span class="p">()</span>
<span class="k">print</span> <span class="s">&quot;The egg was successfully sent to scrapyd server&quot;</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="s">&#39;scrapyd&#39;</span><span class="p">][</span><span class="s">&#39;host&#39;</span><span class="p">],</span> <span class="s">&quot;on port&quot;</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="s">&#39;scrapyd&#39;</span><span class="p">][</span><span class="s">&#39;port&#39;</span><span class="p">]</span>
<span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s">&quot;..&quot;</span><span class="p">)</span>

<span class="k">print</span> <span class="s">&quot;Starting the server&quot;</span>
<span class="n">root_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">__file__</span><span class="p">)</span>    
<span class="n">pp</span> <span class="o">=</span> <span class="n">pprint</span><span class="o">.</span><span class="n">PrettyPrinter</span><span class="p">(</span><span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="n">web_client_dir</span> <span class="o">=</span> <span class="s">&quot;web_client&quot;</span>
<span class="n">data_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root_dir</span><span class="p">,</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;data_dir&quot;</span><span class="p">])</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div><div class='section' id='section-6'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-6'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">class</span> <span class="nc">Home</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">Resource</span><span class="p">):</span>
    <span class="n">isLeaf</span> <span class="o">=</span> <span class="bp">False</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div><div class='section' id='section-7'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-7'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">getChild</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s">&#39;&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span>
        <span class="k">return</span> <span class="n">resource</span><span class="o">.</span><span class="n">Resource</span><span class="o">.</span><span class="n">getChild</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div><div class='section' id='section-8'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-8'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">render_GET</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="n">request</span><span class="o">.</span><span class="n">setHeader</span><span class="p">(</span><span class="s">&quot;Content-Type&quot;</span><span class="p">,</span> <span class="s">&quot;text/html; charset=utf-8&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s">&quot;page&quot;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span> <span class="ow">and</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="s">&quot;page&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&quot;layout&quot;</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">web_client_dir</span><span class="p">,</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">.html&quot;</span> <span class="o">%</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="s">&#39;page&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">path</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">else</span>  <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">web_client_dir</span><span class="p">,</span> <span class="s">&quot;404.html&quot;</span><span class="p">)</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">web_client_dir</span><span class="p">,</span> <span class="s">&quot;index.html&quot;</span><span class="p">)</span>

        <span class="n">layout_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">web_client_dir</span><span class="p">,</span> <span class="s">&quot;layout.html&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">nested</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">&quot;r&quot;</span><span class="p">),</span> <span class="nb">open</span><span class="p">(</span><span class="n">layout_path</span><span class="p">,</span> <span class="s">&quot;r&quot;</span><span class="p">))</span> <span class="k">as</span> <span class="p">(</span><span class="n">fpage</span><span class="p">,</span> <span class="n">flayout</span><span class="p">):</span>
            <span class="n">layout</span> <span class="o">=</span> <span class="n">flayout</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&quot;utf-8&quot;</span><span class="p">)</span>
            <span class="n">page</span> <span class="o">=</span> <span class="n">fpage</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&quot;utf-8&quot;</span><span class="p">)</span>
            <span class="n">content</span> <span class="o">=</span> <span class="n">pystache</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">layout</span><span class="p">,</span> <span class="p">{</span> <span class="s">&quot;contenu&quot;</span> <span class="p">:</span> <span class="n">page</span> <span class="p">})</span>

        <span class="k">return</span> <span class="n">content</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div><div class='section' id='section-9'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-9'>#</a>
      </div>
      <p>attempt to connect to mongo database based on value in config_file</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">_connect_to_db</span><span class="p">():</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div><div class='section' id='section-10'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-10'>#</a>
      </div>
      <p>return db object</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">host</span>   <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s">&#39;mongo&#39;</span><span class="p">][</span><span class="s">&#39;host&#39;</span><span class="p">]</span>
    <span class="n">port</span>   <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s">&#39;mongo&#39;</span><span class="p">][</span><span class="s">&#39;port&#39;</span><span class="p">]</span>
    <span class="n">db</span>     <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s">&#39;mongo&#39;</span><span class="p">][</span><span class="s">&#39;database&#39;</span><span class="p">]</span>
    <span class="n">user</span>   <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s">&#39;mongo&#39;</span><span class="p">][</span><span class="s">&#39;user&#39;</span><span class="p">]</span>
    <span class="n">passwd</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s">&#39;mongo&#39;</span><span class="p">][</span><span class="s">&#39;passwd&#39;</span><span class="p">]</span>

    <span class="k">try</span> <span class="p">:</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">Connection</span><span class="p">(</span><span class="s">&quot;mongodb://&quot;</span> <span class="o">+</span> <span class="n">user</span> <span class="o">+</span>  <span class="s">&quot;:&quot;</span> <span class="o">+</span> <span class="n">passwd</span>  <span class="o">+</span> <span class="s">&quot;@&quot;</span> <span class="o">+</span> <span class="n">host</span> <span class="o">+</span> <span class="s">&quot;:&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">port</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span> <span class="o">+</span> <span class="n">db</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">c</span><span class="p">[</span><span class="n">db</span><span class="p">]</span>
    <span class="k">except</span> <span class="p">:</span>
        <span class="k">print</span> <span class="s">&quot;Could not connect to the database&quot;</span>
        <span class="nb">exit</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div><div class='section' id='section-11'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-11'>#</a>
      </div>
      <p>Advanced research in Google Scholar to URL
areas may contain "bio"  Biology, Life Sciences, and Environmental Science            <br />
                  "med", Medicine, Pharmacology, and Veterinary Science     <br />
                  "bus", Business, Administration, Finance, and Economics
                  "phy", Physics, Astronomy, and Planetary Science
                  "chm", Chemistry and Materials Science    <br />
                  "soc", Social Sciences, Arts, and Humanities
                  "eng", Engineering, Computer Science, and Mathematics</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">scholarize</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">nr_results_per_page</span><span class="o">=</span><span class="s">&quot;100&quot;</span><span class="p">,</span> <span class="n">exact</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">at_least_one</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">,</span>
               <span class="n">without</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">where_words_occurs</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">author</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">publication</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">,</span>
               <span class="n">start_date</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">end_date</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">areas</span> <span class="o">=</span> <span class="p">[]</span> <span class="p">)</span> <span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div><div class='section' id='section-12'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-12'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">return</span> <span class="p">(</span><span class="s">&quot;http://scholar.google.com/scholar?</span><span class="se">\</span>
<span class="s">             as_q=&quot;</span><span class="o">+</span> <span class="n">qp</span><span class="p">(</span><span class="n">query</span><span class="p">)</span> <span class="o">+</span><span class="s">&quot;&amp;num=&quot;</span><span class="o">+</span> <span class="n">nr_results_per_page</span> <span class="o">+</span><span class="s">&quot;&amp; </span><span class="se">\</span>
<span class="s">             as_epq=&quot;</span><span class="o">+</span> <span class="n">qp</span><span class="p">(</span><span class="n">exact</span><span class="p">)</span> <span class="o">+</span><span class="s">&quot;&amp;as_oq=&quot;</span><span class="o">+</span> <span class="n">qp</span><span class="p">(</span><span class="n">at_least_one</span><span class="p">)</span> <span class="o">+</span><span class="s">&quot;&amp; </span><span class="se">\</span>
<span class="s">             as_eq=&quot;</span><span class="o">+</span> <span class="n">qp</span><span class="p">(</span><span class="n">without</span><span class="p">)</span> <span class="o">+</span><span class="s">&quot;&amp;as_occt=&quot;</span><span class="o">+</span> <span class="n">qp</span><span class="p">(</span><span class="n">where_words_occurs</span><span class="p">)</span> <span class="o">+</span><span class="s">&quot;&amp; </span><span class="se">\</span>
<span class="s">             as_sauthors=&quot;</span><span class="o">+</span> <span class="n">qp</span><span class="p">(</span><span class="n">author</span><span class="p">)</span> <span class="o">+</span><span class="s">&quot;&amp;as_publication=&quot;</span><span class="o">+</span> <span class="n">qp</span><span class="p">(</span><span class="n">publication</span><span class="p">)</span> <span class="o">+</span><span class="s">&quot;&amp; </span><span class="se">\</span>
<span class="s">             as_ylo=&quot;</span><span class="o">+</span> <span class="n">start_date</span> <span class="o">+</span><span class="s">&quot;&amp;as_yhi=&quot;</span><span class="o">+</span> <span class="n">end_date</span> <span class="o">+</span><span class="s">&quot;&amp; </span><span class="se">\</span>
<span class="s">             btnG=Search+Scholar&amp;hl=en&amp; </span><span class="se">\</span>
<span class="s">             as_subj=&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s">&#39;&amp;as_subj&#39;</span><span class="p">,</span><span class="n">areas</span><span class="p">)</span> <span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div><div class='section' id='section-13'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-13'>#</a>
      </div>
      <p>JSON-RPC interface</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">class</span> <span class="nc">scholarScape</span><span class="p">(</span><span class="n">jsonrpc</span><span class="o">.</span><span class="n">JSONRPC</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div><div class='section' id='section-14'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-14'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">addSlash</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">projects</span> <span class="o">=</span> <span class="p">[]</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div><div class='section' id='section-15'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-15'>#</a>
      </div>
      <p>JSON-RPC method to start a project</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">jsonrpc_start_project</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">project_name</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div><div class='section' id='section-16'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-16'>#</a>
      </div>
      <p>checking if projects already exists</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">if</span> <span class="n">project_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">db</span><span class="o">.</span><span class="n">collection_names</span><span class="p">()</span> <span class="p">:</span>
            <span class="n">db</span><span class="o">.</span><span class="n">create_collection</span><span class="p">(</span><span class="n">project_name</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">code</span> <span class="o">=</span> <span class="s">&quot;ok&quot;</span><span class="p">,</span> <span class="n">message</span> <span class="o">=</span> <span class="n">project_name</span> <span class="o">+</span> <span class="s">&quot; successfully created.&quot;</span><span class="p">)</span> 
        <span class="k">else</span> <span class="p">:</span>
            <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">code</span> <span class="o">=</span> <span class="s">&quot;fail&quot;</span><span class="p">,</span> <span class="n">message</span> <span class="o">=</span> <span class="s">&quot;Sorry, error&quot;</span> <span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div><div class='section' id='section-17'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-17'>#</a>
      </div>
      <p>JSON-RPC method to get the lists of all the projects</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">jsonrpc_list_project</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div><div class='section' id='section-18'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-18'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">collection_names</span><span class="o">=</span><span class="n">db</span><span class="o">.</span><span class="n">collection_names</span><span class="p">()</span>
        <span class="n">collection_names</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s">&#39;system.indexes&#39;</span><span class="p">)</span>
        <span class="n">collection_names</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s">&#39;system.users&#39;</span><span class="p">)</span>
        <span class="n">collection_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">collection_name</span> <span class="k">for</span> <span class="n">collection_name</span> <span class="ow">in</span> <span class="n">collection_names</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">collection_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot;__&quot;</span><span class="p">)]</span>
        <span class="k">return</span> <span class="n">collection_names</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div><div class='section' id='section-19'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-19'>#</a>
      </div>
      <p>Return lists of duplicates</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">jsonrpc_give_me_duplicates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project</span><span class="p">,</span> <span class="n">campaign</span><span class="p">,</span> <span class="n">limit</span><span class="p">)</span> <span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div><div class='section' id='section-20'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-20'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        
        <span class="n">TITLE_THRESOLD</span> <span class="o">=</span> <span class="mf">0.8</span>
        
        <span class="n">dup_col</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="s">&quot;__dup__&quot;</span><span class="o">+</span><span class="n">project</span><span class="o">+</span><span class="s">&quot;-&quot;</span><span class="o">+</span><span class="n">campaign</span><span class="p">]</span>
        <span class="n">col</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="n">project</span><span class="p">]</span>
        <span class="n">total_number_of_possible_duplicates</span> <span class="o">=</span> <span class="n">dup_col</span><span class="o">.</span><span class="n">find</span><span class="p">({</span>  <span class="s">&quot;title_score&quot;</span> <span class="p">:</span> <span class="p">{</span><span class="s">&quot;$gt&quot;</span> <span class="p">:</span> <span class="n">TITLE_THRESOLD</span><span class="p">,</span> <span class="s">&quot;$lt&quot;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">}</span> <span class="p">})</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
        <span class="n">number_duplicates_already_checked</span> <span class="o">=</span> <span class="n">dup_col</span><span class="o">.</span><span class="n">find</span><span class="p">({</span>  <span class="s">&quot;title_score&quot;</span> <span class="p">:</span> <span class="p">{</span><span class="s">&quot;$gt&quot;</span> <span class="p">:</span> <span class="n">TITLE_THRESOLD</span><span class="p">,</span> <span class="s">&quot;$lt&quot;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">},</span> <span class="s">&quot;human_say&quot;</span> <span class="p">:</span> <span class="p">{</span><span class="s">&quot;$exists&quot;</span> <span class="p">:</span> <span class="bp">True</span><span class="p">}</span>	<span class="p">})</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
        <span class="n">possible_duplicates</span> <span class="o">=</span> <span class="n">dup_col</span><span class="o">.</span><span class="n">find</span><span class="p">({</span>  <span class="s">&quot;title_score&quot;</span> <span class="p">:</span> <span class="p">{</span><span class="s">&quot;$gt&quot;</span> <span class="p">:</span> <span class="n">TITLE_THRESOLD</span><span class="p">,</span> <span class="s">&quot;$lt&quot;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">},</span> <span class="s">&quot;human_say&quot;</span> <span class="p">:</span> <span class="p">{</span><span class="s">&quot;$exists&quot;</span> <span class="p">:</span> <span class="bp">False</span><span class="p">}</span>	<span class="p">})</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="n">limit</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">total_number_of_possible_duplicates</span><span class="p">,</span>
                <span class="n">number_duplicates_already_checked</span><span class="p">,</span>
                <span class="p">[(</span><span class="n">col</span><span class="o">.</span><span class="n">find_one</span><span class="p">(</span> <span class="p">{</span><span class="s">&quot;_id&quot;</span> <span class="p">:</span> <span class="n">pb</span><span class="p">[</span><span class="s">&quot;_id1&quot;</span><span class="p">]</span> <span class="p">})[</span><span class="s">&#39;title&#39;</span><span class="p">],</span>
                  <span class="n">col</span><span class="o">.</span><span class="n">find_one</span><span class="p">(</span> <span class="p">{</span><span class="s">&quot;_id&quot;</span> <span class="p">:</span> <span class="n">pb</span><span class="p">[</span><span class="s">&quot;_id2&quot;</span><span class="p">]</span> <span class="p">})[</span><span class="s">&#39;title&#39;</span><span class="p">],</span>
                  <span class="nb">round</span><span class="p">(</span><span class="n">pb</span><span class="p">[</span><span class="s">&quot;title_score&quot;</span><span class="p">],</span><span class="mi">2</span><span class="p">),</span>
                  <span class="nb">str</span><span class="p">(</span><span class="n">pb</span><span class="p">[</span><span class="s">&quot;_id&quot;</span><span class="p">])</span> 
                 <span class="k">for</span> <span class="n">pb</span> <span class="ow">in</span> <span class="n">possible_duplicates</span><span class="p">])</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div><div class='section' id='section-21'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-21'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">jsonrpc_duplicate_human_check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project</span><span class="p">,</span> <span class="n">campaign</span><span class="p">,</span> <span class="n">dup_id</span><span class="p">,</span> <span class="n">is_duplicate</span><span class="p">):</span>
        <span class="n">collection_name</span> <span class="o">=</span> <span class="s">&quot;__dup__&quot;</span><span class="o">+</span><span class="n">project</span><span class="o">+</span><span class="s">&quot;-&quot;</span><span class="o">+</span><span class="n">campaign</span>
        <span class="k">print</span> <span class="n">collection_name</span>
        <span class="n">dup_id</span> <span class="o">=</span>  <span class="n">objectid</span><span class="o">.</span><span class="n">ObjectId</span><span class="p">(</span><span class="n">dup_id</span><span class="p">)</span>
        <span class="n">db</span><span class="p">[</span><span class="n">collection_name</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s">&quot;_id&quot;</span> <span class="p">:</span> <span class="n">dup_id</span><span class="p">},</span> <span class="p">{</span><span class="s">&quot;$set&quot;</span> <span class="p">:</span> <span class="p">{</span><span class="s">&quot;human_say&quot;</span> <span class="p">:</span> <span class="n">is_duplicate</span><span class="p">}})</span>
        <span class="k">print</span> <span class="n">dup_id</span>
        <span class="k">print</span> <span class="n">db</span><span class="p">[</span><span class="s">&quot;__dup__&quot;</span><span class="o">+</span><span class="n">project</span><span class="o">+</span><span class="s">&quot;-&quot;</span><span class="o">+</span><span class="n">campaign</span><span class="p">]</span><span class="o">.</span><span class="n">find_one</span><span class="p">({</span><span class="s">&quot;_id&quot;</span> <span class="p">:</span> <span class="n">dup_id</span><span class="p">})[</span><span class="s">&#39;human_say&#39;</span><span class="p">]</span>
        <span class="k">print</span>
        <span class="k">if</span> <span class="n">is_duplicate</span> <span class="p">:</span>
            <span class="k">return</span> <span class="s">&quot;Has been marked as duplicate&quot;</span>
        <span class="k">return</span> <span class="s">&quot;Has been unmarked as duplicate&quot;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div><div class='section' id='section-22'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-22'>#</a>
      </div>
      <p>JSON-RPC method to get the lists of all the campaigns in a particular
project.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">jsonrpc_list_campaigns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project_name</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div><div class='section' id='section-23'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-23'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">collection</span><span class="o">=</span><span class="n">db</span><span class="p">[</span><span class="n">project_name</span><span class="p">]</span>

        <span class="n">campaigns</span><span class="o">=</span><span class="p">[</span><span class="n">campaign</span> <span class="k">for</span> <span class="n">campaign</span> <span class="ow">in</span> <span class="n">collection</span><span class="o">.</span><span class="n">find</span><span class="p">({</span><span class="s">&#39;download_delay&#39;</span> <span class="p">:</span> <span class="p">{</span><span class="s">&#39;$exists&#39;</span><span class="p">:</span><span class="bp">True</span><span class="p">}},{</span><span class="s">&quot;_id&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">})</span> <span class="p">]</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">project_name</span><span class="p">,</span><span class="n">campaigns</span><span class="p">]</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div><div class='section' id='section-24'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-24'>#</a>
      </div>
      <p>JSON-RPC method Return a sorted array of arrays containing all the 
projects with all the campaigns</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">jsonrpc_list_all_campaigns</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div><div class='section' id='section-25'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-25'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">collection_names</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">jsonrpc_list_project</span><span class="p">()</span>
        
        <span class="n">projects</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">collection_name</span> <span class="ow">in</span> <span class="n">collection_names</span><span class="p">:</span>
            <span class="n">collection</span><span class="o">=</span><span class="n">db</span><span class="p">[</span><span class="n">collection_name</span><span class="p">]</span>
            <span class="n">campaigns</span><span class="o">=</span><span class="p">[</span><span class="n">campaign</span> <span class="k">for</span> <span class="n">campaign</span> <span class="ow">in</span> <span class="n">collection</span><span class="o">.</span><span class="n">find</span><span class="p">({</span><span class="s">&#39;download_delay&#39;</span> <span class="p">:</span> <span class="p">{</span><span class="s">&#39;$exists&#39;</span><span class="p">:</span><span class="bp">True</span><span class="p">}},{</span><span class="s">&quot;_id&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">})</span> <span class="p">]</span>
            <span class="n">projects</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">collection_name</span><span class="p">,</span><span class="nb">sorted</span><span class="p">(</span><span class="n">campaigns</span><span class="p">,</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">x</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">])])</span>
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">projects</span><span class="p">,</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div><div class='section' id='section-26'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-26'>#</a>
      </div>
      <p>JSON-RPC method to start a campaign.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">jsonrpc_start_campaign</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project</span><span class="p">,</span> <span class="n">campaign</span><span class="p">,</span> <span class="n">search_type</span><span class="p">,</span> <span class="n">starts</span><span class="p">,</span> <span class="n">download_delay</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_start_pages</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">max_cites_pages</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">exact</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div><div class='section' id='section-27'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-27'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">collection</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="n">project</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">collection</span><span class="o">.</span><span class="n">find</span><span class="p">({</span> <span class="s">&quot;name&quot;</span> <span class="p">:</span> <span class="n">campaign</span> <span class="p">})</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">:</span>
            <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">code</span> <span class="o">=</span> <span class="s">&quot;fail&quot;</span><span class="p">,</span> <span class="n">message</span> <span class="o">=</span> <span class="s">&quot;Already existing campaign : campaign could not be created&quot;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div><div class='section' id='section-28'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-28'>#</a>
      </div>
      <p>method to return GS urls based on the choice of the user</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">def</span> <span class="nf">scholarize_custom</span><span class="p">(</span><span class="n">x</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div><div class='section' id='section-29'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-29'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="n">kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            
            <span class="k">if</span> <span class="n">exact</span> <span class="ow">and</span> <span class="n">search_type</span> <span class="o">==</span> <span class="s">&quot;titles&quot;</span> <span class="p">:</span>
                <span class="k">return</span> <span class="n">scholarize</span><span class="p">(</span><span class="n">exact</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">where_words_occurs</span><span class="o">=</span><span class="s">&#39;title&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">exact</span> <span class="ow">and</span> <span class="n">search_type</span> <span class="o">==</span> <span class="s">&quot;words&quot;</span> <span class="p">:</span>
                <span class="k">return</span> <span class="n">scholarize</span><span class="p">(</span><span class="n">exact</span><span class="o">=</span><span class="n">x</span><span class="p">)</span>
                
            <span class="k">if</span> <span class="n">search_type</span> <span class="o">==</span> <span class="s">&quot;words&quot;</span>  <span class="p">:</span>    <span class="k">return</span> <span class="n">scholarize</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="n">x</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">search_type</span> <span class="o">==</span> <span class="s">&quot;titles&quot;</span>  <span class="p">:</span>   <span class="k">return</span> <span class="n">scholarize</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">where_words_occurs</span><span class="o">=</span><span class="s">&#39;title&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">search_type</span> <span class="o">==</span> <span class="s">&quot;authors&quot;</span> <span class="p">:</span>   <span class="k">return</span> <span class="n">scholarize</span><span class="p">(</span><span class="n">author</span><span class="o">=</span><span class="n">x</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">search_type</span> <span class="o">==</span> <span class="s">&quot;urls&quot;</span>    <span class="p">:</span>   <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="s">&quot;&amp;num=100&quot;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div><div class='section' id='section-30'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-30'>#</a>
      </div>
      <p>preparation of the request to scrapyd</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">url</span> <span class="o">=</span> <span class="s">&#39;http://</span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="s">/schedule.json&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;scrapyd&#39;</span><span class="p">][</span><span class="s">&#39;host&#39;</span><span class="p">],</span> <span class="n">config</span><span class="p">[</span><span class="s">&#39;scrapyd&#39;</span><span class="p">][</span><span class="s">&#39;port&#39;</span><span class="p">])</span> 
        <span class="n">values</span> <span class="o">=</span> <span class="p">[(</span><span class="s">&quot;project&quot;</span> <span class="p">,</span> <span class="s">&quot;scholar&quot;</span><span class="p">),</span>
                  <span class="p">(</span><span class="s">&#39;spider&#39;</span> <span class="p">,</span> <span class="s">&#39;scholar_spider&#39;</span><span class="p">),</span>
                  <span class="p">(</span><span class="s">&#39;project_name&#39;</span> <span class="p">,</span> <span class="n">project</span><span class="p">),</span>
                  <span class="p">(</span><span class="s">&#39;setting&#39;</span> <span class="p">,</span> <span class="s">&#39;DOWNLOAD_DELAY=&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">download_delay</span><span class="p">))</span> <span class="p">,</span>
                  <span class="p">(</span><span class="s">&#39;setting&#39;</span> <span class="p">,</span> <span class="s">&#39;DEPTH_LIMIT=&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">depth</span><span class="p">))</span> <span class="p">,</span>
                  <span class="p">(</span><span class="s">&#39;campaign_name&#39;</span> <span class="p">,</span> <span class="n">campaign</span><span class="p">),</span>  
                  <span class="p">(</span><span class="s">&#39;max_start_pages&#39;</span> <span class="p">,</span> <span class="n">max_start_pages</span><span class="p">),</span>  
                  <span class="p">(</span><span class="s">&#39;max_cites_pages&#39;</span> <span class="p">,</span> <span class="n">max_cites_pages</span><span class="p">),</span>  
                  <span class="p">(</span><span class="s">&#39;start_urls_&#39;</span> <span class="p">,</span> <span class="nb">str</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s">&quot;;&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">scholarize_custom</span><span class="p">(</span><span class="n">start</span><span class="p">)</span> <span class="k">for</span> <span class="n">start</span> <span class="ow">in</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span> <span class="p">:</span> <span class="n">x</span><span class="p">,</span> <span class="n">starts</span><span class="p">)])),]</span>
        
        <span class="n">data</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">urlencode</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
        <span class="n">req</span> <span class="o">=</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">Request</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div><div class='section' id='section-31'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-31'>#</a>
      </div>
      <p>sending request</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">try</span> <span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">URLError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">code</span> <span class="o">=</span> <span class="s">&quot;fail&quot;</span><span class="p">,</span> <span class="n">message</span> <span class="o">=</span> <span class="s">&quot;Could not contact scrapyd server, maybe it&#39;s not started...&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">result</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div><div class='section' id='section-32'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-32'>#</a>
      </div>
      <p>reading the response</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">results</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
        <span class="k">print</span> <span class="n">results</span>
        <span class="k">if</span> <span class="n">results</span><span class="p">[</span><span class="s">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;ok&quot;</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">code</span> <span class="o">=</span> <span class="s">&quot;ok&quot;</span><span class="p">,</span> <span class="n">message</span> <span class="o">=</span> <span class="s">&quot;The crawling campaign was successfully launched. You can see it in the Explore section.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
            <span class="n">result</span><span class="p">[</span><span class="s">&#39;job_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s">&quot;jobid&quot;</span><span class="p">])</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div><div class='section' id='section-33'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-33'>#</a>
      </div>
      <p>creation of the campaign object in the DB</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="n">campaign</span> <span class="o">=</span>  <span class="p">{</span><span class="s">&quot;name&quot;</span> <span class="p">:</span> <span class="n">campaign</span><span class="p">,</span>
                         <span class="s">&quot;date&quot;</span> <span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()),</span>
                         <span class="s">&quot;depth&quot;</span> <span class="p">:</span> <span class="n">depth</span><span class="p">,</span>
                         <span class="s">&quot;download_delay&quot;</span> <span class="p">:</span> <span class="n">download_delay</span><span class="p">,</span>
                         <span class="s">&quot;start_urls&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="n">scholarize_custom</span><span class="p">(</span><span class="n">start</span><span class="p">)</span> <span class="k">for</span> <span class="n">start</span> <span class="ow">in</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span> <span class="p">:</span> <span class="n">x</span><span class="p">,</span> <span class="n">starts</span><span class="p">)],</span>
                         <span class="s">&quot;job_id&quot;</span> <span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s">&quot;jobid&quot;</span><span class="p">]),</span>
                         <span class="s">&quot;max_start_pages&quot;</span> <span class="p">:</span> <span class="n">max_start_pages</span><span class="p">,</span>  
                         <span class="s">&quot;max_cites_pages&quot;</span> <span class="p">:</span> <span class="n">max_cites_pages</span><span class="p">,</span>  
                         <span class="s">&quot;status&quot;</span> <span class="p">:</span> <span class="s">&quot;alive&quot;</span><span class="p">,}</span>
            <span class="n">collection</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">campaign</span><span class="p">)</span>   
            <span class="k">return</span> <span class="n">result</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">code</span> <span class="o">=</span> <span class="s">&quot;fail&quot;</span><span class="p">,</span> <span class="n">message</span> <span class="o">=</span> <span class="s">&quot;There was an error telling scrapyd to launch campaign crawl&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">result</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div><div class='section' id='section-34'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-34'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">jsonrpc_cancel_campaign</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project_name</span><span class="p">,</span> <span class="n">campaign</span><span class="p">):</span>
        <span class="n">collection</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="n">project_name</span><span class="p">]</span>
        <span class="n">job_id</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">find_one</span><span class="p">({</span> <span class="s">&quot;name&quot;</span> <span class="p">:</span> <span class="n">campaign</span> <span class="p">})[</span><span class="s">&quot;job_id&quot;</span><span class="p">]</span>
        <span class="n">url</span> <span class="o">=</span> <span class="s">&#39;http://</span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="s">/cancel.json&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;scrapyd&#39;</span><span class="p">][</span><span class="s">&#39;host&#39;</span><span class="p">],</span> <span class="n">config</span><span class="p">[</span><span class="s">&#39;scrapyd&#39;</span><span class="p">][</span><span class="s">&#39;port&#39;</span><span class="p">])</span> 
        <span class="n">values</span> <span class="o">=</span> <span class="p">[(</span><span class="s">&quot;project&quot;</span> <span class="p">,</span> <span class="s">&quot;scholar&quot;</span><span class="p">),</span>
                  <span class="p">(</span><span class="s">&#39;job&#39;</span> <span class="p">,</span> <span class="n">job_id</span><span class="p">),]</span>
        
        <span class="n">data</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">urlencode</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
        <span class="n">req</span> <span class="o">=</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">Request</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div><div class='section' id='section-35'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-35'>#</a>
      </div>
      <p>sending request</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">try</span> <span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">URLError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">code</span> <span class="o">=</span> <span class="s">&quot;fail&quot;</span><span class="p">,</span> <span class="n">message</span> <span class="o">=</span> <span class="s">&quot;Could not contact scrapyd server, maybe it&#39;s not started...&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">result</span>
        
        <span class="n">collection</span><span class="o">.</span><span class="n">update</span><span class="p">(</span> <span class="p">{</span><span class="s">&quot;download_delay&quot;</span> <span class="p">:</span> <span class="p">{</span><span class="s">&quot;$exists&quot;</span> <span class="p">:</span> <span class="bp">True</span><span class="p">},</span> <span class="s">&quot;name&quot;</span> <span class="p">:</span> <span class="n">campaign</span><span class="p">},</span> <span class="p">{</span><span class="s">&quot;$set&quot;</span> <span class="p">:</span> <span class="p">{</span><span class="s">&quot;status&quot;</span> <span class="p">:</span> <span class="s">&quot;finished&quot;</span><span class="p">}})</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div><div class='section' id='section-36'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-36'>#</a>
      </div>
      <p>reading the response</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">results</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">results</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div><div class='section' id='section-37'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-37'>#</a>
      </div>
      <p>JSON-RPC method to export a graph from a particular project/campaign.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">jsonrpc_export_gexf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project_name</span><span class="p">,</span> <span class="n">campaign</span><span class="p">,</span><span class="n">max_depth</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div><div class='section' id='section-38'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-38'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">g</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">Graph</span><span class="p">()</span>
        <span class="n">collection</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="n">project_name</span><span class="p">]</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div><div class='section' id='section-39'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-39'>#</a>
      </div>
      <p>The hash table will act as a translation table child -&gt; parent to
enable that a publication which links to a child will be connected
to the parent instead of the child</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">hash_table</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">children</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;parent_id&quot;</span> <span class="p">:</span> <span class="p">{</span><span class="s">&quot;$exists&quot;</span> <span class="p">:</span> <span class="bp">True</span><span class="p">},</span> <span class="s">&quot;id&quot;</span> <span class="p">:</span> <span class="p">{</span><span class="s">&quot;$exists&quot;</span> <span class="p">:</span> <span class="bp">True</span><span class="p">}}</span>
        <span class="k">if</span> <span class="n">campaign</span> <span class="o">!=</span> <span class="s">&quot;*&quot;</span><span class="p">:</span>
            <span class="n">children</span><span class="p">[</span><span class="s">&#39;campaign&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">campaign</span>
        <span class="k">for</span> <span class="n">publication</span> <span class="ow">in</span> <span class="n">collection</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">children</span><span class="p">)</span> <span class="p">:</span>
            <span class="n">hash_table</span><span class="p">[</span><span class="n">publication</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">publication</span><span class="p">[</span><span class="s">&#39;parent_id&#39;</span><span class="p">])</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div><div class='section' id='section-40'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-40'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">def</span> <span class="nf">add_pub_in_graph</span><span class="p">(</span><span class="n">pub</span><span class="p">)</span> <span class="p">:</span>               
            <span class="n">cites</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="n">publication_id</span> <span class="o">=</span> <span class="n">pub</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">str</span><span class="p">(</span><span class="n">pub</span><span class="p">[</span><span class="s">&#39;_id&#39;</span><span class="p">])</span>
            <span class="n">pub</span><span class="p">[</span><span class="s">&#39;depth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">pub</span><span class="p">[</span><span class="s">&#39;depths&#39;</span><span class="p">])</span>

            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">pub</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="p">:</span>
                <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="s">&quot;abstract&quot;</span> <span class="p">:</span> <span class="c"># we don&#39;t want abstract in the graph</span>
                    <span class="k">del</span> <span class="n">pub</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">k</span> <span class="o">==</span> <span class="s">&quot;cites&quot;</span> <span class="p">:</span> <span class="c"># nor cites because there are the links already</span>
                    <span class="n">cites</span> <span class="o">=</span> <span class="n">pub</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                    <span class="k">del</span> <span class="n">pub</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                <span class="k">else</span> <span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div><div class='section' id='section-41'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-41'>#</a>
      </div>
      <p>anything that is not an int or a float becomes unicode</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">pub</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="o">!=</span> <span class="nb">int</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">pub</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="o">!=</span> <span class="nb">float</span> <span class="p">:</span>
                        <span class="n">pub</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nb">unicode</span><span class="p">(</span><span class="n">pub</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
            
            <span class="n">label</span> <span class="o">=</span> <span class="n">pub</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;title&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s">&quot;&quot;</span>
            <span class="k">if</span> <span class="n">pub</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;title&quot;</span><span class="p">)</span> <span class="p">:</span> <span class="k">del</span> <span class="n">pub</span><span class="p">[</span><span class="s">&quot;title&quot;</span><span class="p">]</span>
            <span class="n">g</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">publication_id</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="o">**</span><span class="n">pub</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">cites</span><span class="p">:</span>
                <span class="n">source</span> <span class="o">=</span> <span class="n">pub</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">str</span><span class="p">(</span><span class="n">pub</span><span class="p">[</span><span class="s">&#39;_id&#39;</span><span class="p">])</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">cites</span><span class="p">)</span> <span class="o">==</span> <span class="nb">unicode</span> <span class="p">:</span>
                    <span class="n">cites</span> <span class="o">=</span> <span class="p">[</span><span class="n">cites</span><span class="p">]</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div><div class='section' id='section-42'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-42'>#</a>
      </div>
      <p>we pass the cited publications through the hash table to get
the parents if there is one</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                <span class="n">targets</span> <span class="o">=</span> <span class="p">[</span><span class="n">hash_table</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cite</span><span class="p">)</span> <span class="ow">or</span> <span class="n">cite</span> <span class="k">for</span> <span class="n">cite</span> <span class="ow">in</span> <span class="n">cites</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">targets</span> <span class="p">:</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">source</span><span class="p">,</span><span class="n">target</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div><div class='section' id='section-43'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-43'>#</a>
      </div>
      <p>getting all the publications that are not children</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">not_children</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;download_delay&quot;</span> <span class="p">:</span> <span class="p">{</span><span class="s">&quot;$exists&quot;</span> <span class="p">:</span> <span class="bp">False</span><span class="p">},</span> <span class="s">&quot;parent_id&quot;</span> <span class="p">:</span> <span class="p">{</span><span class="s">&quot;$exists&quot;</span> <span class="p">:</span> <span class="bp">False</span><span class="p">}}</span> 
        <span class="k">if</span> <span class="n">campaign</span> <span class="o">!=</span> <span class="s">&quot;*&quot;</span> <span class="p">:</span>
            <span class="n">not_children</span><span class="p">[</span><span class="s">&quot;campaign&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">campaign</span>
        <span class="k">for</span> <span class="n">not_child</span> <span class="ow">in</span> <span class="n">collection</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">not_children</span><span class="p">):</span> 
            <span class="n">add_pub_in_graph</span><span class="p">(</span><span class="n">not_child</span><span class="p">)</span> <span class="c">#adding them to the graph</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div><div class='section' id='section-44'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-44'>#</a>
      </div>
      <p>forge a name </p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">__file__</span><span class="p">),</span> <span class="n">data_dir</span><span class="p">,</span> <span class="s">&quot;gexf&quot;</span><span class="p">,</span> <span class="n">project_name</span> <span class="o">+</span> <span class="s">&quot;-&quot;</span> <span class="o">+</span> <span class="n">campaign</span> <span class="o">+</span> <span class="s">&quot;-&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">getrandbits</span><span class="p">(</span><span class="mi">128</span><span class="p">))</span> <span class="o">+</span> <span class="s">&quot;.gexf&quot;</span> <span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div><div class='section' id='section-45'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-45'>#</a>
      </div>
      <p>filter nodes whose depth is &gt; max_depth</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">to_del</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">n</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">iteritems</span><span class="p">()</span> <span class="k">if</span> <span class="n">n</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;depth&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">int</span><span class="p">(</span><span class="n">max_depth</span><span class="p">)]</span>
        <span class="n">g</span><span class="o">.</span><span class="n">remove_nodes_from</span><span class="p">(</span><span class="n">to_del</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div><div class='section' id='section-46'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-46'>#</a>
      </div>
      <p>write graph to gexf file</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">nx</span><span class="o">.</span><span class="n">write_gexf</span><span class="p">(</span><span class="n">g</span><span class="p">,</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">filename</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div><div class='section' id='section-47'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-47'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">jsonrpc_export_duplicates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project</span><span class="p">,</span> <span class="n">campaign</span><span class="p">)</span> <span class="p">:</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">Graph</span><span class="p">()</span>
        <span class="n">collection</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="n">project</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">parent</span> <span class="ow">in</span> <span class="n">collection</span><span class="o">.</span><span class="n">find</span><span class="p">({</span><span class="s">&quot;nr_children&quot;</span> <span class="p">:</span> <span class="p">{</span><span class="s">&quot;$exists&quot;</span> <span class="p">:</span> <span class="bp">True</span><span class="p">},</span> <span class="s">&quot;campaign&quot;</span><span class="p">:</span> <span class="n">campaign</span><span class="p">}</span> <span class="p">)</span> <span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">parent</span><span class="p">[</span><span class="s">&#39;_id&#39;</span><span class="p">]),</span> <span class="n">title</span><span class="o">=</span><span class="n">parent</span><span class="p">[</span><span class="s">&#39;title&#39;</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">collection</span><span class="o">.</span><span class="n">find</span><span class="p">({</span><span class="s">&quot;parent_id&quot;</span> <span class="p">:</span> <span class="p">{</span><span class="s">&quot;$exists&quot;</span> <span class="p">:</span> <span class="bp">True</span><span class="p">}</span> <span class="p">})</span> <span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">child</span><span class="p">[</span><span class="s">&quot;_id&quot;</span><span class="p">]),</span> <span class="n">title</span><span class="o">=</span><span class="n">child</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;title&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s">&quot;&quot;</span><span class="p">)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">child</span><span class="p">[</span><span class="s">&quot;parent_id&quot;</span><span class="p">],</span> <span class="n">child</span><span class="p">[</span><span class="s">&quot;_id&quot;</span><span class="p">])</span>

        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">__file__</span><span class="p">),</span> <span class="n">data_dir</span><span class="p">,</span> <span class="s">&quot;gexf&quot;</span><span class="p">,</span> <span class="s">&quot;duplicates - &quot;</span><span class="o">+</span><span class="n">project</span><span class="o">+</span> <span class="s">&quot;-&quot;</span> <span class="o">+</span> <span class="n">campaign</span> <span class="o">+</span> <span class="s">&quot;-&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">getrandbits</span><span class="p">(</span><span class="mi">128</span><span class="p">))</span> <span class="o">+</span> <span class="s">&quot;.gexf&quot;</span> <span class="p">)</span>
        <span class="n">nx</span><span class="o">.</span><span class="n">write_gexf</span><span class="p">(</span><span class="n">g</span><span class="p">,</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">filename</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div><div class='section' id='section-48'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-48'>#</a>
      </div>
      <p>TODO TODO TODO</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">jsonrpc_export_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project</span><span class="p">,</span> <span class="n">campaign</span><span class="p">)</span> <span class="p">:</span>
        <span class="k">print</span> <span class="s">&quot;Dumping database...&quot;</span>
        <span class="k">if</span> <span class="n">campaign</span> <span class="o">==</span> <span class="s">&quot;*&quot;</span> <span class="p">:</span> <span class="n">campaign</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">__file__</span><span class="p">),</span> <span class="n">data_dir</span><span class="p">,</span> <span class="s">&quot;json&quot;</span><span class="p">,</span> <span class="n">project</span> <span class="o">+</span> <span class="s">&quot;-&quot;</span> <span class="o">+</span> <span class="n">campaign</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">getrandbits</span><span class="p">(</span><span class="mi">128</span><span class="p">))</span> <span class="o">+</span> <span class="s">&quot;.json&quot;</span> <span class="p">)</span>
        <span class="n">export_command</span> <span class="o">=</span> <span class="p">(</span><span class="s">&quot;mongoexport -h &#39;</span><span class="si">%(host)s</span><span class="s">&#39; -d &#39;</span><span class="si">%(database)s</span><span class="s">&#39; -c &#39;</span><span class="si">%(project)s</span><span class="s">&#39; -o </span><span class="si">%(filename)s</span><span class="s">&quot;</span> 
                            <span class="o">%</span> <span class="p">{</span><span class="s">&quot;host&quot;</span> <span class="p">:</span> <span class="n">config</span><span class="p">[</span><span class="s">&quot;mongo&quot;</span><span class="p">][</span><span class="s">&quot;host&quot;</span><span class="p">],</span> 
                               <span class="s">&quot;database&quot;</span> <span class="p">:</span> <span class="n">config</span><span class="p">[</span><span class="s">&quot;mongo&quot;</span><span class="p">][</span><span class="s">&quot;database&quot;</span><span class="p">],</span> 
                               <span class="s">&quot;project&quot;</span> <span class="p">:</span> <span class="n">project</span><span class="p">,</span> 
                               <span class="s">&quot;filename&quot;</span> <span class="p">:</span> <span class="n">filename</span><span class="p">})</span>
        <span class="k">if</span> <span class="n">campaign</span> <span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;$or&quot;</span> <span class="p">:</span> <span class="p">[</span> 
                        <span class="p">{</span><span class="s">&quot;campaign&quot;</span> <span class="p">:</span> <span class="n">campaign</span><span class="p">,</span> <span class="s">&quot;download_delay&quot;</span> <span class="p">:</span> <span class="p">{</span><span class="s">&quot;$exists&quot;</span> <span class="p">:</span> <span class="bp">False</span><span class="p">}},</span> 
                        <span class="p">{</span><span class="s">&quot;name&quot;</span> <span class="p">:</span> <span class="n">campaign</span><span class="p">,</span> <span class="s">&quot;download_delay&quot;</span> <span class="p">:</span> <span class="p">{</span><span class="s">&quot;$exists&quot;</span> <span class="p">:</span> <span class="bp">True</span><span class="p">}</span> <span class="p">}]}</span> 
            <span class="n">export_command</span> <span class="o">+=</span> <span class="s">&quot;-q &#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span> <span class="o">%</span> <span class="n">query</span>
        <span class="k">print</span> <span class="n">export_command</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">shlex</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">export_command</span><span class="p">)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="k">print</span> <span class="s">&quot;Done.&quot;</span>
        <span class="k">return</span> <span class="n">filename</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div><div class='section' id='section-49'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-49'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">jsonrpc_export_zip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">project_name</span><span class="p">)</span> <span class="p">:</span>
        <span class="n">json_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jsonrpc_export_json</span><span class="p">(</span><span class="n">project_name</span><span class="p">)</span>
        <span class="n">gexf_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jsonrpc_export_gexf</span><span class="p">(</span><span class="n">project_name</span><span class="p">)</span>

        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">__file__</span><span class="p">),</span> <span class="n">data_dir</span><span class="p">,</span> <span class="s">&quot;zip&quot;</span><span class="p">,</span> <span class="n">project_name</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">getrandbits</span><span class="p">(</span><span class="mi">128</span><span class="p">))</span> <span class="o">+</span> <span class="s">&quot;.zip&quot;</span> <span class="p">)</span>
        <span class="n">zip_file</span> <span class="o">=</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="s">&#39;w&#39;</span><span class="p">,</span><span class="n">compression</span><span class="o">=</span><span class="n">zipfile</span><span class="o">.</span><span class="n">ZIP_DEFLATED</span><span class="p">)</span>
        <span class="n">zip_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json_file</span><span class="p">)</span>
        <span class="n">zip_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">gexf_file</span><span class="p">)</span>
        <span class="n">zip_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">filename</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div><div class='section' id='section-50'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-50'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">jsonrpc_monitor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project_name</span><span class="p">,</span> <span class="n">campaign_name</span><span class="p">)</span> <span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div><div class='section' id='section-51'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-51'>#</a>
      </div>
      <p>nombre d'items</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">collection</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="n">project_name</span><span class="p">]</span>
        <span class="n">nb_super</span>   <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">find</span><span class="p">({</span><span class="s">&quot;campaign&quot;</span> <span class="p">:</span> <span class="n">campaign_name</span><span class="p">,</span> <span class="s">&quot;nr_children&quot;</span> <span class="p">:</span> <span class="p">{</span><span class="s">&quot;$exists&quot;</span> <span class="p">:</span> <span class="bp">True</span><span class="p">}})</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
        <span class="n">nb_items</span>   <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">find</span><span class="p">({</span><span class="s">&quot;campaign&quot;</span> <span class="p">:</span> <span class="n">campaign_name</span><span class="p">})</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>  <span class="o">-</span> <span class="n">nb_super</span>
        <span class="n">last_items</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">collection</span><span class="o">.</span><span class="n">find</span><span class="p">({</span><span class="s">&quot;campaign&quot;</span> <span class="p">:</span> <span class="n">campaign_name</span> <span class="p">},</span> 
                                          <span class="p">{</span><span class="s">&quot;_id&quot;</span> <span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="s">&quot;parent_id&quot;</span> <span class="p">:</span> <span class="bp">False</span><span class="p">}</span> <span class="p">)</span>
                                    <span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">sort</span><span class="p">([</span> <span class="p">(</span><span class="s">&quot;$natural&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">])</span> <span class="p">)</span> <span class="c"># most recent items</span>
        <span class="n">campaign</span>     <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">find</span><span class="p">({</span><span class="s">&quot;download_delay&quot;</span> <span class="p">:</span> <span class="p">{</span><span class="s">&quot;$exists&quot;</span> <span class="p">:</span> <span class="bp">True</span><span class="p">},</span>
                                        <span class="s">&quot;name&quot;</span> <span class="p">:</span> <span class="n">campaign_name</span><span class="p">})[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">del</span> <span class="n">campaign</span><span class="p">[</span><span class="s">&#39;_id&#39;</span><span class="p">]</span>
        
        <span class="n">retour</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;code&quot;</span> <span class="p">:</span> <span class="s">&quot;ok&quot;</span><span class="p">,</span>
                  <span class="s">&quot;message&quot;</span> <span class="p">:</span> <span class="p">{</span><span class="s">&quot;nb_super&quot;</span>  <span class="p">:</span> <span class="n">nb_super</span><span class="p">,</span>
                               <span class="s">&quot;nb_items&quot;</span>  <span class="p">:</span> <span class="n">nb_items</span><span class="p">,</span>
                               <span class="s">&quot;last_items&quot;</span><span class="p">:</span> <span class="n">last_items</span><span class="p">,</span>
                               <span class="s">&quot;campaign&quot;</span>    <span class="p">:</span> <span class="n">campaign</span><span class="p">}}</span>
        <span class="k">return</span> <span class="n">retour</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div><div class='section' id='section-52'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-52'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">jsonrpc_monitor_project</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project_name</span><span class="p">)</span> <span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div><div class='section' id='section-53'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-53'>#</a>
      </div>
      <p>nombre d'items</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">collection</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="n">project_name</span><span class="p">]</span>
        <span class="n">nb_campaigns</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">find</span><span class="p">({</span><span class="s">&quot;download_delay&quot;</span> <span class="p">:</span> <span class="p">{</span><span class="s">&quot;$exists&quot;</span> <span class="p">:</span> <span class="bp">True</span><span class="p">}})</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
        <span class="n">nb_items</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">find</span><span class="p">({</span><span class="s">&quot;title&quot;</span> <span class="p">:</span> <span class="p">{</span><span class="s">&quot;$exists&quot;</span> <span class="p">:</span> <span class="bp">True</span><span class="p">}})</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">{</span><span class="s">&quot;nb_campaigns&quot;</span> <span class="p">:</span> <span class="n">nb_campaigns</span><span class="p">,</span>
                <span class="s">&quot;nb_items&quot;</span>     <span class="p">:</span> <span class="n">nb_items</span><span class="p">}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div><div class='section' id='section-54'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-54'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">jsonrpc_remove_project</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">project_name</span><span class="p">)</span> <span class="p">:</span>
        <span class="k">try</span> <span class="p">:</span> 
            <span class="n">db</span><span class="o">.</span><span class="n">drop_collection</span><span class="p">(</span><span class="n">project_name</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">db</span><span class="o">.</span><span class="n">collection_names</span><span class="p">():</span> 
                <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot;__dup__&quot;</span> <span class="o">+</span> <span class="n">project_name</span> <span class="o">+</span> <span class="s">&quot;-&quot;</span><span class="p">)</span> <span class="p">:</span>
                    <span class="n">db</span><span class="o">.</span><span class="n">drop_collection</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> 
            <span class="k">return</span> <span class="p">{</span><span class="s">&quot;code&quot;</span><span class="p">:</span><span class="s">&quot;ok&quot;</span><span class="p">,</span><span class="s">&quot;message&quot;</span> <span class="p">:</span> <span class="s">&quot;Project &quot;</span> <span class="o">+</span> <span class="n">project_name</span> <span class="o">+</span> <span class="s">&quot; was deleted successfully&quot;</span><span class="p">}</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s">&quot;code&quot;</span> <span class="p">:</span> <span class="s">&quot;fail&quot;</span><span class="p">,</span> <span class="s">&quot;message&quot;</span> <span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div><div class='section' id='section-55'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-55'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">jsonrpc_remove_campaign</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">project_name</span><span class="p">,</span><span class="n">campaign_name</span><span class="p">):</span>
        <span class="k">try</span> <span class="p">:</span>
            <span class="n">collection</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="n">project_name</span><span class="p">]</span>
            <span class="n">collection</span><span class="o">.</span><span class="n">remove</span><span class="p">({</span><span class="s">&quot;campaign&quot;</span><span class="p">:</span><span class="n">campaign_name</span><span class="p">})</span>
            <span class="n">collection</span><span class="o">.</span><span class="n">remove</span><span class="p">({</span><span class="s">&quot;download_delay&quot;</span><span class="p">:{</span><span class="s">&quot;$exists&quot;</span><span class="p">:</span><span class="bp">True</span><span class="p">},</span> <span class="s">&quot;name&quot;</span><span class="p">:</span><span class="n">campaign_name</span><span class="p">})</span>
            <span class="k">return</span> <span class="p">{</span><span class="s">&quot;code&quot;</span><span class="p">:</span><span class="s">&quot;ok&quot;</span><span class="p">,</span><span class="s">&quot;message&quot;</span> <span class="p">:</span> <span class="s">&quot;Campaign &quot;</span> <span class="o">+</span> <span class="n">campaign_name</span> <span class="o">+</span> <span class="s">&quot; was deleted successfully&quot;</span><span class="p">}</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s">&quot;code&quot;</span> <span class="p">:</span><span class="s">&quot;fail&quot;</span><span class="p">,</span> <span class="s">&quot;message&quot;</span> <span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div><div class='section' id='section-56'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-56'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">class</span> <span class="nc">Downloader</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">Resource</span><span class="p">):</span>
    <span class="n">isLeaf</span> <span class="o">=</span> <span class="bp">True</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div><div class='section' id='section-57'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-57'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">render_GET</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="k">try</span> <span class="p">:</span>
            <span class="n">file_path</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="s">&#39;file&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">request</span><span class="o">.</span><span class="n">setHeader</span><span class="p">(</span><span class="s">&#39;Content-Disposition&#39;</span><span class="p">,</span> <span class="s">&#39;attachment;filename=&#39;</span><span class="o">+</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="s">&#39;file&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> 
            <span class="k">return</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&quot;There was an error &quot;</span> <span class="o">+</span> <span class="s">&quot; &quot;</span> <span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> 

<span class="n">db</span> <span class="o">=</span>  <span class="n">_connect_to_db</span><span class="p">()</span>
<span class="n">application</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">Application</span><span class="p">(</span><span class="s">&quot;ScholarScape server. Receives JSON-RPC Requests and also serves the client.&quot;</span><span class="p">)</span>
<span class="n">root</span> <span class="o">=</span> <span class="n">Home</span><span class="p">()</span>

<span class="n">manageJson</span> <span class="o">=</span> <span class="n">scholarScape</span><span class="p">()</span>
<span class="n">root</span><span class="o">.</span><span class="n">putChild</span><span class="p">(</span><span class="s">&#39;downloader&#39;</span><span class="p">,</span> <span class="n">Downloader</span><span class="p">())</span>
<span class="n">root</span><span class="o">.</span><span class="n">putChild</span><span class="p">(</span><span class="s">&#39;json&#39;</span><span class="p">,</span> <span class="n">manageJson</span><span class="p">)</span>
<span class="n">root</span><span class="o">.</span><span class="n">putChild</span><span class="p">(</span><span class="s">&#39;js&#39;</span><span class="p">,</span> <span class="n">static</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root_dir</span><span class="p">,</span> <span class="n">web_client_dir</span><span class="p">,</span><span class="s">&quot;js&quot;</span><span class="p">)))</span>
<span class="n">root</span><span class="o">.</span><span class="n">putChild</span><span class="p">(</span><span class="s">&#39;css&#39;</span><span class="p">,</span> <span class="n">static</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root_dir</span><span class="p">,</span> <span class="n">web_client_dir</span><span class="p">,</span><span class="s">&quot;css&quot;</span><span class="p">)))</span>
<span class="n">root</span><span class="o">.</span><span class="n">putChild</span><span class="p">(</span><span class="s">&#39;fonts&#39;</span><span class="p">,</span> <span class="n">static</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root_dir</span><span class="p">,</span> <span class="n">web_client_dir</span><span class="p">,</span><span class="s">&quot;fonts&quot;</span><span class="p">)))</span>
<span class="n">root</span><span class="o">.</span><span class="n">putChild</span><span class="p">(</span><span class="s">&#39;images&#39;</span><span class="p">,</span> <span class="n">static</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root_dir</span><span class="p">,</span> <span class="n">web_client_dir</span><span class="p">,</span><span class="s">&quot;images&quot;</span><span class="p">)))</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">File</span><span class="p">(</span><span class="s">&quot;data&quot;</span><span class="p">)</span>
<span class="n">root</span><span class="o">.</span><span class="n">putChild</span><span class="p">(</span><span class="s">&quot;data&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
<span class="n">site</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="n">Site</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
<span class="n">server</span> <span class="o">=</span> <span class="n">internet</span><span class="o">.</span><span class="n">TCPServer</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;twisted&quot;</span><span class="p">][</span><span class="s">&quot;port&quot;</span><span class="p">],</span> <span class="n">site</span><span class="p">)</span>
<span class="n">server</span><span class="o">.</span><span class="n">setServiceParent</span><span class="p">(</span><span class="n">application</span><span class="p">)</span>

</pre></div>
    </div>
  </div>
  <div class='clearall'></div>
</div>
</body>
